
# Firestore Data Seeder Script

This script is used to populate your Firestore database with mock data for testing and development purposes. It uses the `@faker-js/faker` library to generate realistic-looking data and `firebase-admin` to interact directly with Firestore and Firebase Authentication.

The seeding logic is organized into individual modules within the `scripts/seeders/` directory. The main `scripts/seed.ts` file orchestrates these modules.

## Prerequisites

1.  **Node.js and pnpm:** Ensure you have Node.js (v18 or later recommended) and pnpm installed.
2.  **Firebase Project:** You must have a Firebase project set up. It's **highly recommended** to run this script against a development or staging Firebase project, not your production project.
3.  **Firebase Admin SDK Credentials:**
    *   Go to your Firebase project settings in the Firebase Console.
    *   Navigate to the "Service accounts" tab.
    *   Click on "Generate new private key" and download the JSON file.
    *   **Important:** Keep this file secure and do **NOT** commit it to your Git repository.
    *   You need to make these credentials available to the script. There are two main ways:
        *   **Primary Method: `FIREBASE_SERVICE_ACCOUNT_JSON_STRING` Environment Variable**
            *   Set this environment variable to the stringified content of your service account JSON file. The script will attempt to parse this.
            *   To get the stringified content: `cat /path/to/your/serviceAccountKey.json | jq -c .` (requires `jq`) or copy-paste the content of the JSON file, ensuring it's a valid single-line JSON string. Ensure any newline characters `\n` within the private key are properly escaped as `\\n` if setting this in a `.env` file, or kept as actual newlines if your environment variable system supports multi-line strings. The script attempts to replace `\\n` with `\n` for the private key.
        *   **Alternative: `GOOGLE_APPLICATION_CREDENTIALS` Environment Variable**
            *   If `FIREBASE_SERVICE_ACCOUNT_JSON_STRING` is not set, the script will fall back to using `GOOGLE_APPLICATION_CREDENTIALS`. Set this environment variable to the absolute path of the downloaded JSON key file.
                *   On macOS/Linux: `export GOOGLE_APPLICATION_CREDENTIALS="/path/to/your/serviceAccountKey.json"`
                *   On Windows (PowerShell): `$env:GOOGLE_APPLICATION_CREDENTIALS="/path/to/your/serviceAccountKey.json"`
                *   (Replace `/path/to/your/serviceAccountKey.json` with the actual path to your file).
4.  **Firebase Project ID:** Ensure `NEXT_PUBLIC_FIREBASE_PROJECT_ID` is correctly set in your `.env` file in the project root.

## Setup & Customization

1.  **Install Dependencies:**
    If you haven't already, install the necessary development dependencies (they should be in your `package.json`):
    ```bash
    pnpm install
    ```
    The script uses `tsx` to run TypeScript files directly.

2.  **Customize Data Generation Amounts:**
    *   Open the main orchestrator script: `scripts/seed.ts`.
    *   At the top of this file, you'll find configuration constants like `NUM_SCHOOLS`, `NUM_TEACHERS_PER_SCHOOL`, `NUM_STUDENTS_PER_SCHOOL`, etc.
    *   Adjust these numbers to control how much data is generated by the individual seeder modules when running the full seed.
    *   You can also inspect individual seeder files in `scripts/seeders/` if you need to fine-tune the data generation logic itself (e.g., specific Faker.js parameters).

## Running the Seeders

1.  **Set Up Credentials:** Ensure your Firebase Admin SDK credentials and Project ID are set up as described in the "Prerequisites" section.

2.  **Execute the Scripts:**

    *   **To Run All Seeders (Recommended for a fresh database):**
        This will run all individual seeders in the correct order, ensuring data dependencies are met.
        From the root of your project, run:
        ```bash
        pnpm seed
        ```
        (This is equivalent to `tsx scripts/seed.ts all`)

    *   **To Run Individual Seeders:**
        You can run specific seeders if needed. The `package.json` contains scripts for each. For example:
        ```bash
        pnpm seed:schools       # Seeds only schools
        pnpm seed:users         # Seeds users (requires schools to exist)
        pnpm seed:subjects      # Seeds subjects (requires schools to exist)
        pnpm seed:classes       # Seeds classes (requires schools, users, subjects)
        pnpm seed:materials     # Seeds learning materials
        pnpm seed:assignments   # Seeds assignments and submissions
        pnpm seed:examperiods   # Seeds exam periods
        pnpm seed:examresults   # Seeds exam results
        pnpm seed:attendance    # Seeds attendance records
        pnpm seed:testimonials  # Seeds testimonials
        ```
        **Important Note on Individual Seeders:** When running an individual seeder (e.g., `pnpm seed:users`), it assumes that any prerequisite data (e.g., schools for users) already exists in the database. If you are starting with an empty database and want to run seeders individually, you must run them in a logical order (e.g., `seed:schools` first, then `seed:users`, then `seed:subjects`, and so on). The individual seeder scripts will attempt to fetch necessary prerequisites if they are not provided directly from a previous step in the same execution run.

3.  **Monitor Output:** The script will log its progress to the console, indicating which collections are being seeded and when it's complete. Check for any error messages.

## Troubleshooting

*   **"Could not load the default credentials" / Authentication Errors:**
    *   This means the script cannot find valid authentication credentials for your Firebase project.
    *   Ensure your `FIREBASE_SERVICE_ACCOUNT_JSON_STRING` or `GOOGLE_APPLICATION_CREDENTIALS` environment variable is correctly set.
    *   If using `FIREBASE_SERVICE_ACCOUNT_JSON_STRING`, ensure it's a valid, single-line JSON string (or correctly escaped for `.env`). The script attempts to fix `\\n` in private keys for `.env` usage.
    *   Verify the service account JSON file itself is valid and has not been corrupted.
    *   Ensure the service account has the necessary Firestore and Authentication permissions in your Firebase project (usually "Firebase Admin SDK Administrator Service Agent" or at least "Editor" or specific Firestore/Auth admin roles).
*   **"Unable to detect a Project Id" / Project ID Errors:**
    *   Ensure `NEXT_PUBLIC_FIREBASE_PROJECT_ID` is correctly set in your `.env` file.
    *   Verify that your service account JSON file also contains a `project_id` field that matches your Firebase project.
*   **Rate Limiting (e.g., `auth/quota-exceeded`):**
    *   The user creation seeder (`scripts/seeders/seedUsers.ts`) includes a basic retry mechanism for Firebase Auth rate limits. If you are seeding a very large number of users, you might still encounter this. Consider reducing the number of users or running the seeder in smaller batches by adjusting constants in `scripts/seed.ts`.
*   **Dependency Errors when running individual seeders:** If you run a seeder like `pnpm seed:users` without schools existing, it will fail. Ensure prerequisites are met or run `pnpm seed` for a full, ordered seed.

## Important Notes

*   **Data Overwriting/Duplication:**
    *   The script attempts to avoid creating duplicate Firebase Authentication users if an email already exists by fetching the existing user's UID.
    *   For Firestore data, the script generally creates new documents with unique IDs. If you run the script multiple times, it will add *new* data, not overwrite existing mock data (unless you modify the script to specifically do so).
    *   If you need to clear old mock data, you might need to do so manually via the Firebase console or write a separate cleanup script. The `scripts/clearAllUsers/seed.ts` utility can clear Firebase Auth users.
*   **Security:**
    *   **Never commit your Firebase Admin SDK service account key to your repository.**
    *   Be cautious about the data Faker.js generates if you have very specific data validation rules in your Firestore security rules that the mock data might not meet.
*   **Performance:** For very large datasets, seeding can take time.
*   **Idempotency:** This script is not fully idempotent by default (meaning running it multiple times might produce slightly different states or more data).

By following these steps, you should be able to populate your Firestore database with mock data to facilitate comprehensive testing of your Learnify application.

```
